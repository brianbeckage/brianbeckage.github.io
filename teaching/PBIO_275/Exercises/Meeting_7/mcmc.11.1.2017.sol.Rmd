---
title: "JAGS"
output: html_notebook
---

# Install JAGS from https://sourceforge.net/projects/mcmc-jags/?source=typ_redirect

```{r}
setwd("~/Documents/Web/Teaching/PBIO_294/Exercises/11.1.2017")
```


### Some required libraries:

```{r}

### If not already installed:
install.packages("rjags")
install.packages("runjags")
install.packages("coda")

```


Generating some data to recapture using a linear regression

```{r}
N <- 1000
x <- 1:N
epsilon <- rnorm(N, 0, 1)
y <- x + epsilon

# or

nReps<-10
x<-seq(from=0,to=100,by=1)
x<-rep(x,nReps)
b0<-1.0; b1<-0.2
ymean<-b0+b1*x
y<-rnorm(n=length(ymean),mean=ymean,sd=1.5)
N<-length(y)

```


Writing simulated data to external file
```{r}
write.table(data.frame(X = x, Y = y),
            file = 'lm_example1.data',
            row.names = FALSE,
            col.names = TRUE)
```

JAGS model

```{r}
modelString<-"
model {
  for (i in 1:N){
    y[i] ~ dnorm(y.hat[i], tau)
    y.hat[i] <- a + b * x[i]
  }
  a ~ dnorm(0, .0001)
  b ~ dnorm(0, .0001)
  tau <- pow(sigma, -2)
  sigma ~ dunif(0, 100)
}
"
writeLines(modelString, con='LM_ex1.txt')

```

Compiling model

```{r}
require('rjags')

jags <- jags.model('LM_ex1.txt',
                   data = list('x' = x,
                               'y' = y,
                               'N' = N),
                   inits<-list(
                       list('a'=1,'b'=2,'sigma'=5),
                       list('a'=1,'b'=.2,'sigma'=0.5),
                       list('a'=.1,'b'=2,'sigma'=7),
                       list('a'=2,'b'=5,'sigma'=1)),
                   n.chains = 4,
                   n.adapt = 100)
```

Updating model

```{r}
update(jags, 1000)
```

Sampoling from model

```{r}
codaSamples<-coda.samples(jags, c('a','b','sigma'), 1000, 1)
```

Examining fit using CODA

```{r}
require(coda)
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```

Compared to b0 = 1.0; b1 = 0.2, sd=1.5


### Exercise 1:  Fit the same model using library runjags wih 4 parallel chains

Code for simulating data
```{r}
nReps<-10
x<-seq(from=0,to=100,by=1)
x<-rep(x,nReps)
b0<-1.0; b1<-0.2
ymean<-b0+b1*x
y<-rnorm(n=length(ymean),mean=ymean,sd=1.5)
N<-length(y)
```


### RUNJAGS

```{r}
nChains<-4
nAdaptSteps<-1000
nBurninSteps<-500
nUseSteps<-10000 # total number of used steps
nThinSteps<-2

```


```{r}
library(runjags)

runJagsOut <- run.jags( method='parallel',
model='LM_ex1.txt',
monitor=c('a','b','sigma') ,
data=list('x' = x, 'y' = y, 'N' = N),
inits=list(
          list('a'=1,'b'=2,'sigma'=5),
          list('a'=1,'b'=.2,'sigma'=0.5),
          list('a'=.1,'b'=2,'sigma'=7),
          list('a'=2,'b'=5,'sigma'=1)),
n.chains=nChains ,
adapt=nAdaptSteps ,
burnin=nBurninSteps ,
sample=ceiling(nUseSteps/nChains) ,
thin=nThinSteps ,
summarise=FALSE ,
plots=FALSE )

```


Examining fit using CODA

```{r}
require(coda)
codaSamples = as.mcmc.list( runJagsOut )
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```

```{r}
gelman.plot(codaSamples)
```



### Exercise 2:  Fit a linear model to the height vs weight data from 6 Sep 2017: wt<-b0 + b1*ht

Reading in data
```{r}
wtData<-read.table("http://www.uvm.edu/~bbeckage/Teaching/DataAnalysis/Data/wts.txt",header=TRUE)
head(wtData)

require(ggplot2)

ggplot(wtData,aes(height_in,weight_lbs))+ # geom_smooth(method='lm') +
  geom_point()

```

```{r}
require('rjags')

jags <- jags.model('LM_ex1.txt',
                   data = list('x' = wtData$height_in,
                               'y' = wtData$weight_lbs,
                               'N' = dim(wtData)[1]),
                   inits<-list(
                       list('a'=1,'b'=2,'sigma'=5),
                       list('a'=1,'b'=.2,'sigma'=0.5),
                       list('a'=.1,'b'=2,'sigma'=7),
                       list('a'=2,'b'=5,'sigma'=1)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(jags, 1000)
codaSamples<-coda.samples(jags, c('a','b','sigma'), 1000000, 100)

```

Examining fit

```{r}
require(coda)
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
gelman.plot(codaSamples)
```


