---
title: "PBIO_Pett_HW_DUE_DEC_1"
output: html_notebook
---
### Binomial Regression Model 

We observed seedling survival in a in a forest.  At each seedlng, we measure an integrated metric of light levels.  We want to estimate a logistic regression model for these data to determine the relationship between light levels and seedlng survival.  The model will be of the form:
logit(p)<-beta0 + beta1 * light
seedling ~ binomial(n=1, p)

Repeat steps 1-6 from the Poisson regression model above except for the binomial model.

Please use the following code to simulate data in order to recapture model paramters (beta0 and beta1):

Simulating data for a binomial regression.

```{r}
beta0<- -1.0; beta1<-3.0
light<-runif(1000)
pVect<-exp(beta0+beta1*light)/(1+exp(beta0+beta1*light))
range(pVect)
seedlingSurv<-rbinom(n=length(light),size=1,prob=pVect)

seedlingSurvData<-data.frame(light,seedlingSurv) # if you want a data frame
plot(light,seedlingSurv)
```
### 1. Fit the binomial regression using maximum likelihood.

The likelihood function:

```{r}
binomialll<-function(parVec,sdlgs,lght){
    beta0<-parVec[1]
    beta1<-parVec[2]
  logit<-exp(beta0+beta1*light)
  nllik<- -sum(dbinom(x=sdlgs,log=TRUE, size=1, prob=.5))
  # cat("nllik= ",nllik,sep=" ",fill=T);cat(" ",sep=" ",fill=T)
  return(nllik)
}
```


```{r}
parVec<-c(0.5,1.0) # Initial parameter values 
outBinom<-optim(par=parVec,fn=binomialll,method="L-BFGS-B",lower=c(-Inf,-Inf),upper=c(Inf,Inf),sdlgs=seedlingSurv,lght=light)
outBinom$par 
outBinom$val 
myAIC<-2*2 + 2*outBinom$val 
```

Plotting Binomial regression fit to the data:

```{r}
lightPred<-light[order(light)]
plot(light,seedlingSurv)
lines(lightPred,
exp(outBinom$par[1]+outBinom$par[2]*lightPred),col='red',lwd=2)
```


###2. Compare your maximum likelihood fit to the R glm function.
```{r}
outglm<-glm(seedlingSurv~light, family=binomial,data=seedlingSurvData)
summary(outglm)
```

###3. Compare your fit to Stan using brms library
```{r}
library(brms)
library(ggplot2)
outStan<-brm(formula=seedlingSurv~light,
						 data=seedlingSurvData,family=binomial())
summary(outStan)
plot(outStan)

#marginal_effects only worked with family=bernoullie()
outstan1<-brm(formula=seedlingSurv~light,
							data=seedlingSurvData,family=bernoulli(),
							prior=c(set_prior("normal (0,100)",class="b")),
							warmup=1000,iter=2000,chains=4)

summary(outstan1)
plot(outstan1)

plot(marginal_effects(outstan1), points=TRUE)
```


###4. Compare your fit to stan using rstanarm library
```{r}
library(rstanarm)
outrstanarm<-stan_glm(seedlingSurv~light,data=seedlingSurvData,family=
binomial,iter=2000,warmup=1000,cores=4)

summary(outrstanarm)
plot(outrstanarm)
```


###5. Fit the Binomial regression using Rstan
```{r}
library(rstan)
myData<-list(seedlingSurv,light=light,N=length(light))



modelString<-'
data{
                int<lower=0>N;
                int<lower=0,upper=1>seedlingSurv[N];
  vector[N] light;         
}
parameters{
  real alpha; //intercept
                real betalight; //beta for light
}
model{
alpha ~ normal(0,100);
betalight ~ normal(0,100);
seedlingSurv ~ bernoulli_logit(alpha + betalight * light);
}
'
is_arg_recognizable <- function(x, y, pre_msg = '', post_msg = '', ...) {
  # check if all elements of x are in y.
  # x: a vector of characters
  # y: a vector of characters
  idx <- match(x, y)
  na_idx <- which(is.na(idx))
  if (length(na_idx) > 0) {
    stop(pre_msg, paste(x[na_idx], collapse = ', '), ".", post_msg, ...)
  }
  return(TRUE)
}
resStan<-stan(model_code=modelString,data=myData,
							chains=4,iter=1000)
summary(resStan,par=c('alpha','betalight'))
```
```{r}
library(coda)
post_fit<-As.mcmc.list(resStan)
plot(post_fit)
```


###6.Fit the Binomial regression using Rjags

```{r}
cat(
"model {
  for (i in 1:N){
  seedlingSurv[i] ~ dbern(mu[i])
   logit(mu[i]) <- alpha + betalight * light[i]
  }
  alpha ~ dnorm(0, 1.0E-12)
  betalight ~ dnorm(0, 1.0E-12)
}", file="logistic.jag"
)

library(rjags)
jags <- jags.model('logistic.jag',
                   data = list('seedlingSurv' = seedlingSurv,
                               'light' = light,
                               'N' = length(light)),
                   inits<-list(
                       list('alpha'=1,'betalight'=2),
                       list('alpha'=1,'betalight'=.2),
                       list('alpha'=.1,'betalight'=2),
                       list('alpha'=2,'betalight'=5)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(jags, 1000)

jags.samples(jags,
             c('alpha', 'betalight'),
             10000)
```
```{r}
library(coda)
codaSamples<-coda.samples(jags, c('alpha','betalight'), 10000, 1)
```
```{r}
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```


```