---
title: "GLMs""
author: "Kacey Clougher"
date: "11/15/2017"
output: html_document
---

Two classes of GLM's: regression for Poisson and Bionomial data

#Poisson
Observed: Seedling counts in a set of quadrats place in a forest. Each quadrat, we measure an integrated metric of light levels. We want to estimate a poisson regression model for these data ti determin the relationship between light levels and seedling abundance. 

```{r}

light<-runif(1000)
# Alt specification for light levels: light=c(0.10, 0.18, 0.26, 0.33, 0.41, 0.49, 0.57, 0.64, 0.72, 0.80)
# Alt specification for light levels: light<-seq(0.1, 0.8,len=10)

beta0<-1.0; beta1<-3.0
lam<-exp(beta0+beta1*light) # this is equivalent to ln(lambda)<-beta0+beta1*light
nSeedlings<-rpois(n=length(lam),lambda=lam)

seedlingData<-data.frame(light,nSeedlings) # if you want a data frame
plot(light,nSeedlings)


```



### 1. Fit the Poisson regression using maximum likelihood.

The likelihood function:

```{r}
nllPoi<-function(parVec,sdlgs,lght){
    b0<-parVec[1]
    b1<-parVec[2]
  sdlgPred<-exp(b0+b1*lght)
  nllik<- -sum(dpois(x=sdlgs,lambda=sdlgPred,log=TRUE))
  # cat("nllik= ",nllik,sep=" ",fill=T);cat(" ",sep=" ",fill=T)
  return(nllik)
}

```


```{r}
parVec<-c(0.5,1.0) # Initial parameter values 
outPois<-optim(par=parVec,fn=nllPoi,method="L-BFGS-B",lower=c(-Inf,-Inf),upper=c(Inf,Inf),sdlgs=nSeedlings,lght=light)
outPois$par # 1.01036 2.98204
outPois$val # nllik 2676.105
myAIC<-2*2 + 2*outPois$val # 5356.21

```



Plotting Poisson regression fit to the data:

```{r}
lightPred<-light[order(light)]
plot(light,nSeedlings)
lines(lightPred, exp(outPois$par[1]+outPois$par[2]*lightPred),col='red',lwd=2)
```




### Method 2. Compare your maximum likelihood fit to the R glm function.

```{r}
outglm<-glm(nSeedlings~light, family=poisson,data=seedlingData)
summary(outglm)
```



### 3.  Compare your fit to Stan using brms library

```{r}
library(brms)
library(Rcpp)
library(ggplot2)

outStan <- brm(formula = nSeedlings ~ light,
            data = seedlingData, family = poisson())


summary(outStan)
plot(outStan)



plot(marginal_effects(outStan), points = TRUE)
```

The R glm model and Stan arevery comparable; both intercepts and light estimations are within .10 of each other. 





### 4. Compare your fit to Stan using rstanarm library


```{r}
library(rstanarm)
outrstanarm<-stan_glm(nSeedlings ~ light,data = seedlingData, family = poisson, iter=2000, warmup=1000, cores=4)

summary(outrstanarm)
plot(outrstanarm)

```



### 5. Fit the Poisson regression using Rstan


```{r}
library(rstan)
myData<-list(nSeedlings=nSeedlings,light=light,N=length(light))

resStan <- stan(model_code = 'poissonReg.stan', data = myData,
                chains = 3, iter = 3000, warmup = 500, thin = 10)

resStan <- stan(model_code = modelString, data = myData,
                chains = 3, iter = 3000, warmup = 500, thin = 10)
suppressMessages(summary(resStan,par=c('beta0','beta1')))

```

```{r}
library(coda)
post_fit<-As.mcmc.list(resStan) 
plot(post_fit)
```


```{r}
modelString<-"data {
  int<lower=0> N;
  real<lower=0,upper=1> light[N];
  int<lower=0> nSeedlings[N];
}

parameters {
  real beta0;
  real beta1;
}

transformed parameters {
  real lp[N];
  real <lower=0> mu[N];
  
  for(i in 1:N){
    lp[i] = beta0 + beta1 * light[i];
    mu[i] = exp(lp[i]);
  }
}

model {
  nSeedlings ~ poisson(mu);
}"
```




### 6. Fit the Poisson regression using Rjags


```{r}
library(coda)
library(rjags)


jags <- jags.model('poissonReg.jags.txt',
                   data = list('nSeedlings' = nSeedlings,
                               'light' = light,
                               'N' = length(light)),
                   inits<-list(
                       list('beta0'=1,'beta1'=2),
                       list('beta0'=1,'beta1'=.2),
                       list('beta0'=.1,'beta1'=2),
                       list('beta0'=2,'beta1'=5)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(jags, 1000)

jags.samples(jags,
             c('beta0', 'beta1'),
             10000)
```
```{r}
library(coda)
codaSamples<-coda.samples(jags, c('beta0','beta1'), 10000, 1)
```

```{r}
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```


```{r}
modelString<-"
model {
  for (i in 1:N){
    nSeedlings[i] ~ dpois(lam.hat[i])
    log(lam.hat[i]) <- beta0 + beta1 * light[i]
  }
  beta0 ~ dnorm(0, .0001)
  beta1 ~ dnorm(0, .0001)
}
"
writeLines(modelString, con='poissonReg.jags.txt')
```




### Binomial Regression Model 

We observed seedling survival in a in a forest.  At each seedlng, we measure an integrated metric of light levels.  We want to estimate a logistic regression model for these data to determine the relationship between light levels and seedlng survival.  The model will be of the form:
logit(p)<-beta0 + beta1 * light
seedling ~ binomial(n=1, p)

Repeat steps 1-6 from the Poisson regression model above except for the binomial model.

Please use the following code to simulate data in order to recapture model paramters (beta0 and beta1):

Simulating data for a binomial regression. 

```{r}
beta0<- -1.0; beta1<-3.0
light<-runif(1000)
pVect<-exp(beta0+beta1*light)/(1+exp(beta0+beta1*light))
range(pVect)
seedlingSurv<-rbinom(n=length(light),size=1,prob=pVect)

seedlingSurvData<-data.frame(light,seedlingSurv) # if you want a data frame
plot(light,seedlingSurv)

```

1) Fitting the binomial regression model using maximum likelihood.

```{r}

#Binomial likelihood fxn
bnLL<- function(pVect, sdling, lght){
  bet0 = pVect[1]
  bet1 = pVect[2]
  seedPredict = bet0/(1 + bet0 *bet1 * lght)
  nLL<- -sum(dbinom(sdling, prob = seedPredict, size = length(lght), log = TRUE))
  return(nLL)
}

#maximizing it

library(Rvmmin)
pVect<- c(0.5, 1.0)
outBin<- Rvmmin(par = pVect, fn = bnLL, lower = c(-Inf,0), upper = c(Inf, Inf), data=seedlingSurv)


outBin$value
outBin$par

binAIC<- 2*2 +2 *outBin$value
binAIC



```


3) Compare your maximum likelihood fit to the R glm function

```{r}

#logit(p)<-beta0 + beta1 * light
#seedling ~ binomial(n=1, p)

binGLM<- glm(seedlingSurv ~ light, family = binomial(link = "logit"), data = seedlingSurvData)
summary(binGLM)











```

3) Compare your fit to Stan using brms library

```{r}
library(brms)
library(Rcpp)
library(ggplot2)

binSTAN<- brm(formula = seedlingSurv ~ light, data = seedlingSurvData, family = binomial(link = "logit"))
summary(binSTAN)
plot(binSTAN)




```

4) Compare your fit to Stan using rstanarm library
```{r}
library(rstanarm)

binArm<- stan_glm(seedlingSurv ~ light, data = seedlingSurvData, family = binomial("logit"), iter = 2000, warmup = 1000, cores = 4)

summary(binArm)
plot(binArm)



```

5) Fit the binomial regression using Rstan

```{r}



#ready data
library(rstan)
dat<- list(seedlingSurv = seedlingSurv, light = light, N = length(light))

#write data to file
write.table(dat,
            file = 'binomial.data',
            row.names = FALSE,
            col.names = TRUE)
 
#fitting model
bresStan<- stan(model_code = binomialRegr, data = dat, chains = 4, iter = 3000, warmup = 500, thin = 10)


summary(bresStan, par = c('beta0', 'beta1'))

#coda mcmc 
library(coda)
posto<- As.mcmc.list(bresStan)
plot(posto)
```

```{r}
#model string 

binomialRegr<- "data{
  int<lower = 0> N;
  real<lower = 0, upper = 1> light[N];
  int<lower = 0 > seedlingSurv[N];
}

parameters {
  real beta0;
  real beta1;
}

transformed parameters {
  real lp[N];
  real <lower = 0> mu[N];

  for (i in 1:N){
  lp[i] = beta0 + beta1 * light [i];
  mu[i] = exp(lp[i]);

  }
}

model {
seedlingSurv ~ binomial(mu)
}"





```

6) Fit binomial regression model using Rjags
```{r}
library(rjags)
bjags<- jags.model('binomialReg.jags.txt', data = list('seedlingSurv' = seedlingSurv, 'light' = light, 'N' = length(light)), 
                   inits<- list(
                    list('beta0' = 1, 'beta1' = 2), 
                    list('beta0' = 1,'beta1' = .2),
                    list('beta0' = .1,'beta1' = 2),
                    list('beta0' = 2,'beta1' = 5)),
                   n.chains = 4, 
                   n.adapt = 100
                   )

update(bjags, 1000)
jags.samples(bjags, 
             c('beta0', 'beta1'), 
            10000)

library(coda)
codaSamps<- coda.samples(bjags, c('beta0', 'beta1'), 10000, 1)

plot(codaSamps, trace = FALSE, density = TRUE)
summary(codaSamps)
traceplot(codaSamps)


modelString<-"
model {
  for (i in 1:N){
seedlingSurv[i] ~ dbinom(lam.hat[i])
    log(lam.hat[i]) <- beta0 + beta1 * light[i]
  }
  beta0 ~ dnorm(0, .0001)
  beta1 ~ dnorm(0, .0001)
}
"
writeLines(modelString, con='binomialReg.jags.txt')



```












