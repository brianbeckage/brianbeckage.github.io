---
title: "R Notebook"
output: html_notebook
---

### binomial Regression Model 

We observed seedling counts in a set of quadrats placed in a forest.  At each quadrat, we measure an integrated metric of light levels.  We want to estimate a binomial regression model for these data to determine the relationship between light levels and seedlng abundance.

We can use the following code to simulate data in order to recapture model paramters:

```{r}
beta0<- -1.0; beta1<-3.0
light<-runif(1000)
pVect<-exp(beta0+beta1*light)/(1+exp(beta0+beta1*light))
range(pVect)
seedlingSurv<-rbinom(n=length(light),size=1,prob=pVect)
seedlingSurvData<-data.frame(light,seedlingSurv) 
plot(light,seedlingSurv)
```


### 1. Fit the binomial regression using maximum likelihood.

The likelihood function:

```{r}
nllBin<-function(pVect,sdlgs,lght){
    b0<-pVect[1]
    b1<-pVect[2]
  sdlgPred<- exp(b0+b1*lght)
  nllik<- -sum(dbinom(x=sdlgs ,size=1,prob=sdlgPred,log=TRUE))
  return(nllik)
}
myPVect<-c(-1.0,3.0)
mySdlgs<-seedlingSurvData$seedlingSurv
myLght<-seedlingSurvData$light
nllBin(myPVect,mySdlgs,myLght)
```


```{r}
pVect<-c(0.5,1.0) # Initial parameter values 
outBin<-optim(par=pVect,fn=nllBin,method="L-BFGS-B",lower=c(-Inf,-Inf),upper=c(Inf,Inf),sdlgs=seedlingSurv,lght=light)
outBin$par 
outBin$val
myAIC<-2*2 + 2*outBin$val

```

Plotting binomial regression fit to the data:

```{r}


lightPred<-light[order(light)]
plot(light,seedlingSurv)
lines(lightPred, exp(outBin$par[1]+outBin$par[2]*lightPred),col='red',lwd=2)
```

### 2. Compare your maximum likelihood fit to the R glm function.

```{r}
outglm<-glm(seedlingSurv~light, family=binomial,data=seedlingSurvData)
summary(outglm)
```


### 3.  Compare your fit to Stan using brms library


```{r}
library(brms)

outStan <- brm(formula = seedlingSurv ~ light,
            data = seedlingSurvData, family = bernoulli())


summary(outStan)
plot(outStan)


outStan1 <- brm(formula = seedlingSurv ~ light,
            data = seedlingSurvData, family = binomial(),
            prior = c(set_prior("normal(0,100)", class = "b")),
            warmup = 1000, iter = 2000, chains = 4)

summary(outStan1)
plot(outStan1)


plot(marginal_effects(outStan1), points = TRUE)
```



### 4. Compare your fit to Stan using rstanarm library

```{r}
library(rstanarm)
outrstanarm<-stan_glm(seedlingSurv ~ light,data = seedlingSurvData, family = binomial, iter=2000, warmup=1000, cores=4)

summary(outrstanarm)
plot(outrstanarm)

```



### 5. Fit the binomial regression using Rstan

```{r}
install.packages("rstan")
```


```{r}
library(rstan)
myData<-list(seedlingSurv=seedlingSurv,light=light,N=length(light))

resStan <- stan(model_code = 'binomialReg.stan', data = myData,
                chains = 3, iter = 3000, warmup = 500, thin = 10)

resStan <- stan(model_code = modelString, data = myData,
                chains = 3, iter = 3000, warmup = 500, thin = 10)
summary(resStan,par=c('beta0','beta1'))

```
```{r}
install.packages("coda")
```


```{r}
library(coda)
post_fit<-As.mcmc.list(resStan) 
plot(post_fit)
```

### 6. Fit the binomial regression using Rjags

```{r}
install.packages("rjags")
```


```{r}
library(rjags)
jags <- jags.model('binomialReg.jags.txt',
                   data = list('seedlingSurv' = seedlingSurv,
                               'light' = light,
                               'N' = length(light)),
                   inits<-list(
                       list('beta0'=1,'beta1'=2),
                       list('beta0'=1,'beta1'=.2),
                       list('beta0'=.1,'beta1'=2),
                       list('beta0'=2,'beta1'=5)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(jags, 1000)

jags.samples(jags,
             c('beta0', 'beta1'),
             10000)
```
```{r}
library(coda)
codaSamples<-coda.samples(jags, c('beta0','beta1'), 10000, 1)
```

```{r}
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```


```{r}
modelString<-"
model {
  for (i in 1:N){
    seedlingSurv[i] ~ dpois(lam.hat[i])
    log(lam.hat[i]) <- beta0 + beta1 * light[i]
  }
  beta0 ~ dnorm(0, .0001)
  beta1 ~ dnorm(0, .0001)
}
"
writeLines(modelString, con='binomialReg.jags.txt')
```

