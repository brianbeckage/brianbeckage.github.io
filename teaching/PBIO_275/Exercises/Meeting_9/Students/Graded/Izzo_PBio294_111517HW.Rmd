---
title: "Izzo_PBIO294_111517HW"
author: "LisaIzzo"
date: "November 15, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Binomial Regression Model 

We observed seedling survival in a in a forest.  At each seedlng, we measure an integrated metric of light levels.  We want to estimate a logistic regression model for these data to determine the relationship between light levels and seedlng survival.  The model will be of the form:
logit(p)<-beta0 + beta1 * light
seedling ~ binomial(n=1, p)

Repeat steps 1-6 from the Poisson regression model above except for the binomial model.

Please use the following code to simulate data in order to recapture model paramters (beta0 and beta1):

Simulating data for a binomial regression. 

```{r}
beta0<- -1.0; beta1<-3.0
light<-runif(1000)
pVect<-exp(beta0+beta1*light)/(1+exp(beta0+beta1*light))
range(pVect)
seedlingSurv<-rbinom(n=length(light),size=1,prob=pVect)

seedlingSurvData<-data.frame(light,seedlingSurv) # if you want a data frame
plot(light,seedlingSurv)

```


### 1. Fit the Logistic regression using maximum likelihood.

The likelihood function:

```{r}
nllBinom<-function(parVec,seeds,light){
    b0<-parVec[1]
    b1<-parVec[2]
  seedlingPred<-(exp(b0+b1*light))/((1 + exp(b0+b1*light)))
  nllikB<- -sum(dbinom(x=seeds, size=1, prob=seedlingPred,log=TRUE))
  return(nllikB)
}
```


```{r}
parVec<-c(5,5) # Initial parameter values 
MLEBinom_optim<-optim(par=parVec,fn=nllBinom,method="L-BFGS-B",lower=c(-Inf,-Inf),upper=c(Inf,Inf),seeds=seedlingSurvData$seedlingSurv,light=seedlingSurvData$light)
MLEBinom_optim$par 
MLEBinom_optim$val 
myAIC<-2*2 + 2*MLEBinom_optim$val
myAIC

```

Plotting MLE Binomial regression fit to the data:

```{r}
lightvec<-light[order(seedlingSurvData$light)]
plot(seedlingSurvData$light,seedlingSurvData$seedlingSurv, 
     pch = 19, ylab = "Seedling Survival", xlab = "Light")
lines(lightvec, (exp(MLEBinom_optim$par[1]+MLEBinom_optim$par[2]*lightvec))/((1 + exp(MLEBinom_optim$par[1]+MLEBinom_optim$par[2]*lightvec))),col='darkcyan',lwd=2)
```

### 2. Compare your maximum likelihood fit to the R glm function.

```{r}
Binomglm<-glm(seedlingSurv~light, family=binomial,data=seedlingSurvData)
summary(Binomglm)
```


### 3.  Compare your fit to Stan using brms library

```{r}
library(brms)

BinomStan <- brm(formula = seedlingSurv~light,
            data=seedlingSurvData, family = binomial())

summary(BinomStan)
plot(BinomStan)


plot(marginal_effects(BinomStan), points = TRUE)
```



### 4. Compare your fit to Stan using rstanarm library


```{r}
library(rstanarm)
options(mc.cores = parallel::detectCores())
Binomrstanarm<-stan_glm(seedlingSurv~light,data = seedlingSurvData, family = binomial, iter=2000, warmup=1000, cores=4)

summary(Binomrstanarm)
plot(Binomrstanarm)

```



### 5. Fit the Binomial regression using Rstan

```{r}

setwd("~/UVM/Classes/EcoModeling2017")

BinommodelStringSTAN<-"data {
  int<lower=0> N;
  real<lower=0,upper=1> light[N];
  int<lower=0, upper=1> seedlingSurv[N];
}

parameters {
  real beta0;
  real beta1;
}

transformed parameters {
  real lp[N];
  real <lower=0> p[N];
  
  for(i in 1:N){
    lp[i] = beta0 + beta1 * light[i];
    p[i] = (exp(lp[i]))/(1+exp(lp[i]));
  }
}

model {
    seedlingSurv ~ binomial(1,p);
}"

writeLines(BinommodelStringSTAN, con='BinomReg.stan')
```


```{r}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
myData<-list(seedlingSurv=seedlingSurvData$seedlingSurv,light=seedlingSurvData$light,N=nrow(seedlingSurvData))

BinomresStan <- stan(model_code = BinommodelStringSTAN, data = myData,
                chains = 3, iter = 3000, warmup = 500, thin = 10)

summary(BinomresStan,par=c('beta0','beta1'))

```

```{r}
library(coda)

Binom_b0<-As.mcmc.list(BinomresStan,pars="beta0")
plot(Binom_b0)

Binom_b1<-As.mcmc.list(BinomresStan,pars="beta1")
plot(Binom_b1)

```




### 6. Fit the Binomial regression using Rjags


```{r}
BinommodelStringJAGS<-"
model {
  for (i in 1:N){
    seedlingSurv[i] ~ dbinom(theta.hat[i], 1)
    logit(theta.hat[i]) <- beta0 + beta1 * light[i]
  }
  beta0 ~ dnorm(0, .0001)
  beta1 ~ dnorm(0, .0001)
}
"
writeLines(BinommodelStringJAGS, con='BinomReg.jags.txt')
```

```{r}
library(rjags)
Binomjags <- jags.model('BinomReg.jags.txt',
              data = list('seedlingSurv'= seedlingSurvData$seedlingSurv,
                          'light' = seedlingSurvData$light,
                          'N' = nrow(seedlingSurvData)),
                   inits<-list(
                       list('beta0'=0.5,'beta1'=2),
                       list('beta0'=1,'beta1'=0.1),
                       list('beta0'=0.3,'beta1'=0.5),
                       list('beta0'=2,'beta1'=5)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(Binomjags, 1000)

jags.samples(Binomjags,
             c('beta0', 'beta1'),
             10000)
```


```{r}
library(coda)
codaSamples<-coda.samples(Binomjags, c('beta0','beta1'), 10000, 1)
```


```{r}
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
```



