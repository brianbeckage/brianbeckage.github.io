---
title: "Stan"
output: html_notebook
---

# Install Stan
https://github.com/stan-dev/rstan/wiki/Installing-RStan-on-Mac-or-Linux#toolchain

see for compiler warnings: https://github.com/stan-dev/rstan/issues/389

```{r}
dotR <- file.path(Sys.getenv("HOME"), ".R")
if (!file.exists(dotR)) dir.create(dotR)
M <- file.path(dotR, "Makevars")
if (!file.exists(M)) file.create(M)
cat("\nCXXFLAGS=-O3 -mtune=native -march=native -Wno-unused-variable -Wno-unused-function", 
    file = M, sep = "\n", append = TRUE)
```

```{r}
cat("\nCC=clang", "CXX=clang++ -arch x86_64 -ftemplate-depth-256", 
    file = M, sep = "\n", append = TRUE)
```

Checking installation setup
```{r}
cat(readLines(M), sep = "\n")
cat(M)
```

Compiling from source
```{r}
Sys.setenv(MAKEFLAGS = "-j4") 

install.packages("rstan", type = "source")

```


```{r}

install.packages("rstan", repos = "https://cloud.r-project.org/", dependencies=TRUE)

```

Checking installation: Test 1

```{r}
fx <- inline::cxxfunction( signature(x = "integer", y = "numeric" ) , '
	return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;
' )
fx( 2L, 5 )
```


Checking installation: Test 2
Fitting test model and data

1. Setting directory and loading Stan
```{r}
setwd("~/Documents/Web/Teaching/PBIO_294/Exercises/11.8.2017")

library(rstan)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

2. Writing model file

```{r}

stanModel<-"
data {
  int<lower=0> J; // number of schools 
  real y[J]; // estimated treatment effects
  real<lower=0> sigma[J]; // s.e. of effect estimates 
}
parameters {
  real mu; 
  real<lower=0> tau;
  real eta[J];
}
transformed parameters {
  real theta[J];
  for (j in 1:J)
    theta[j] = mu + tau * eta[j];
}
model {
  target += normal_lpdf(eta | 0, 1);
  target += normal_lpdf(y | theta, sigma);
}
"
writeLines(stanModel, con='stanModel.stan')
```

3. Creating data and fitting model
```{r}

schools_dat <- list(J = 8, 
                    y = c(28,  8, -3,  7, -1,  1, 18, 12),
                    sigma = c(15, 10, 16, 11,  9, 11, 10, 18))

fit <- stan(file = 'stanModel.stan', data = schools_dat, 
            iter = 1000, chains = 1)

```






```{r}
schools_dat <- list(J = 8, 
                    y = c(28,  8, -3,  7, -1,  1, 18, 12),
                    sigma = c(15, 10, 16, 11,  9, 11, 10, 18))

fit <- stan(file = "https://raw.githubusercontent.com/stan-dev/example-models/master/misc/eight_schools/eight_schools.stan", 
            data = schools_dat, iter = 1000, chains = 4)
```
```{r}
plot(fit)
pairs(fit,pars = c("mu", "tau"))
```

```{r}
library(coda)
post_fit<-As.mcmc.list(fit) 
plot(post_fit)
```

# Linear Regression using Stan

Generating some data to recapture using a linear regression

```{r}

nReps<-10
x<-seq(from=0,to=100,by=1)
x<-rep(x,nReps)
b0<-1.0; b1<-0.2
ymean<-b0+b1*x
y<-rnorm(n=length(ymean),mean=ymean,sd=1.5)
N<-length(y)
myData<-data.frame(weights_lb=x,heights=y)

```


Writing simulated data to external file
```{r}
write.table(myData,
            file = 'lm_example1.data',
            row.names = FALSE,
            col.names = TRUE)
```


Compared to b0 = 1.0; b1 = 0.2, sd=1.5

### Exercise 1:  Fit the same model using library runjags wih 4 parallel chains


```{r}
library(rstan)

myDat <- list(N = N, 
                     x= x,
                     y = y)

fit <- stan(model_code  = stanRegressionModel, data = myDat, iter=1000)

            #,pars = c('beta0','beta1','sigma'))
            # iter = 1000, chains = 4)
summary(fit,par=c('beta0','beta1','sigma'))
```



```{r}
stanRegressionModel<-"
data {
int<lower=0> N; 
vector[N] x; 
vector[N] y; 
}

parameters {
  real beta0;
  real beta1;
  real <lower=0> sigma;
}

transformed parameters {
 vector[N] ypred;
 ypred = beta0 + beta1*x;

}

model {
beta0 ~ cauchy(0,10); 
beta1 ~ cauchy(0,10);
sigma ~ cauchy(0,10);
y ~ normal(ypred,sigma);
}
"

# writeLines(stanRegressionModel, con='stanRegressionModel.stan')
```



Examining fit using CODA

```{r}
require(coda)
codaSamples = as.mcmc.list( runJagsOut )
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
gelman.plot(codaSamples)

```








### Exercise 2:  Fit a linear model to the height vs weight data from 6 Sep 2017: wt<-b0 + b1*ht

Reading in data
```{r}
wtData<-read.table("http://www.uvm.edu/~bbeckage/Teaching/DataAnalysis/Data/wts.txt",header=TRUE)
head(wtData)

require(ggplot2)

ggplot(wtData,aes(height_in,weight_lbs))+ # geom_smooth(method='lm') +
  geom_point()

```

Examining fit

```{r}
require(coda)
plot(codaSamples, trace = FALSE, density = TRUE)
summary(codaSamples)
traceplot(codaSamples)
gelman.plot(codaSamples)
```


