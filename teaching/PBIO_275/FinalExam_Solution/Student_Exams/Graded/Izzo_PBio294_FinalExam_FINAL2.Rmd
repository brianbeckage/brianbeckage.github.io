---
title: "Izzo_PBIO294_FinalExam"
author: "Lisa Izzo"
date: "December 7, 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
##Set working directory 
setwd("~/Vermont/Classes/Fall 2017/EcologicalModeling/EMFinalExam")

```


```{r}
##Load necessary libraries for all questions
library(rjags)
library(coda)
```

1. (30 points) An ecologist is interested in the intermediate disturbance hypothesis (IDH) that postulates that the highest species richness should be found at intermediate levels of disturbance. Write a  likelihood function to estimate the parameters for a quadratic regression models given in Beckage and Stout 2000 (http://www.uvm.edu/~bbeckage/Manuscripts/BeckageStout.corrected.2000.jvs.pdf), but assuming a Poisson likelihood with a log link function.

Provide your i. *likelihood function and supporting R code for finding the MLE's*, ii. a *plot of the data with the fitted line* and iii. report the *regression parameters (bo, b1, and b2)*, and iv. the value of the *negative log likelihood at the MLEs*.  Note:  You must write your own likelihood function and not use a built in R function or package, e.g, lm, glm, etc.

Quadratic model from Beckage and Stout 2000: 
*Y = B0 + B1 × Burns + B2 × Burns2 + e*

```{r}
##read in and check data 
srDat<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/idh.csv",sep=',',header=TRUE)
head(srDat)
str(srDat)

##make column for squared values for use in quadratic regression
srDat$nFires2 = srDat$nFires^2

```

Part i: 
```{r}
##Negative log likelihood function (Poisson) for the quadratic regression
nll_pois_fires2 = function(paramVec, SR, fire, fire2){
  beta0 = paramVec[1]
  beta1 = paramVec[2]
  beta2 = paramVec[3]
  lambda_sr = exp(beta0 + beta1*fire + beta2*fire2)
  nllik = -sum(dpois(x = SR,lambda = lambda_sr,log=TRUE))
  return(nllik)
}
```


```{r}
##Optimize negative log likelihood function to find parameter MLEs
paramVec = c(1, 1, -1) # Initial parameter values 
              #based on shape of data points, we expect beta 2 to be negative 

MLE_nll_fire2<-optim(par = paramVec, fn = nll_pois_fires2, 
                     method = "L-BFGS-B", 
                     lower = c(-Inf,-Inf,-Inf), upper = c(Inf,Inf,Inf),
                     SR = srDat$sr, fire = srDat$nFires, 
                     fire2 = srDat$nFires2)

MLE_nll_fire2$par

```

Part ii: 
```{r}
##Plot data points and fitted regression line based on MLE 
predict_fires = srDat$nFires[order(srDat$nFires)]
plot(srDat$sr ~ srDat$nFires, ylab = "SR", xlab = "Number of Fires", pch = 19)

lines(predict_fires, exp(MLE_nll_fire2$par[1] +
                           MLE_nll_fire2$par[2]*predict_fires +
                           MLE_nll_fire2$par[3]*predict_fires^2),
                            col='darkcyan',lwd=2)
```

Part iii:
```{r}
beta0_MLE = MLE_nll_fire2$par[1]
beta1_MLE = MLE_nll_fire2$par[2]
beta2_MLE = MLE_nll_fire2$par[3]

print(beta0_MLE)
print(beta1_MLE)
print(beta2_MLE)

```
The parameter estimates using the MLE method are:
Beta0 = 2.055
Beta1 = 0.444
Beta2 = -0.046

Part iv: 
```{r}
MLE_nll_fire2$value
```
The value of the negative log likelihood at the MLEs is 848.1428. 



2. (30 points) Repeat exercise 1 except now fitting the model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*, ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (bo, b1, and b2)*, iii. *plot the posterior distributions for each of these parameters* and iv. *assess the convergence of your chains using the Gelman-Rubin statistic.* 

Part i: 
```{r}
##specify JAGS model

Fire_Quadratic_JAGSmod <- " 
 model {
  for (i in 1:N){
    SR[i] ~ dpois(lambda[i])
    log(lambda[i]) <- beta0 + beta1 * Fire[i] + beta2 * pow(Fire[i], 2)
  }
  #priors
  beta0 ~ dnorm(0, 0.001)
  beta1 ~ dnorm(0, 0.001)
  beta2 ~ dnorm(0, 0.001)
}
"

writeLines(Fire_Quadratic_JAGSmod, con='Fire_Quadratic_JAGSmod.txt')

```


```{r}
##put data into list to be used in JAGS

srDatList = list(SR = srDat$sr, 
                 Fire = srDat$nFires,
                 N = nrow(srDat))

##set chains, burn in, and iterations
nchains = 4
nburnin = 200
niter = 20000

##run JAGS model 

Fires_JAGS = jags.model('Fire_Quadratic_JAGSmod.txt',
                        data = srDatList, 
                        n.chains = nchains,
                        n.adapt = 100)

update(Fires_JAGS, nburnin)
jags.samples(Fires_JAGS, c("beta0", "beta1", "beta2"), niter)

```

Part ii: 
```{r}
##sample JAGS model using coda package to summarize model results  
Fires_coda = coda.samples(Fires_JAGS, c("beta0", "beta1", "beta2"), niter)

```

The parameter estimates and the 2.5%, 50%, and 97.5% percentiles are: 
```{r}
##summarize parameter estimates 
summary(Fires_coda)
```

Part iii:
```{r}
##plot posterior distributions of each parameter 
plot(Fires_coda, trace = FALSE)
```

Part iv: 
```{r}
##check traceplots for any visual signs of lack of convergence 
par(mfrow = c(3,1))
traceplot(Fires_coda)


gelman.plot(Fires_coda)
gelman.diag(Fires_coda)
```

The Gelman-Rubin statistic is very close to 1 for all paramters, indicating that the chains have converged.  



3. (40 points) An ecologist expects seed predation to be influenced by the presence of openings (gaps) in the forest overstory and seed mass. The effect of seed mass on predation is expected be quadratic:  Small seeds will be less predated because they offer a lower energetic reward while larger seeds will be too difficult to process, so that medium sized seeds will be most predated.  The effect of a gap is additive with lower predation expected in gaps because seed predators avoid areas of open canopy. The ecologist models the data as a hierarchical logistic regression, assuming that the seed masses are known without observation error.  The model has the form:

Seed lost ~ Binomial(theta) # 1 if seed is predated, 0 if seed is left alone
Logit(theta) = b0i + b1 x gap 
b0i ~ gamma(mu^2/sd^2,mu/sd^2) 
mui = b2 + b3 x seed mass i - b4 x (seed mass i)^2 
sd^2 ~ gamma(0.001,0.001)
b1,b2,b3,b4 ~ normal(0,100)

Fit this model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*, ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (b1, b1, b2, b3, and b4)*, iii. *plot the posterior distributions for each of these parameters* and iv. *assess the convergence of your chains using the Gelman-Rubin statistic.*

```{r}
##read in and check data 
seeds<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/seeds.csv",sep=',',header=TRUE)
head(seeds)
str(seeds)

##add squared column for quadratic model
seeds$mass2 = seeds$mass^2

```

Part i: 
```{r}
##specify JAGS model

Seeds_HM_JAGSmod <- " 
 model {

  for (i in 1:N){
    SeedLost[i] ~ dbern(theta[i])
    logit(theta[i]) <- beta0[i] + beta1 * Gap[i]
  }

  for (i in 1:N){ 
    beta0[i] ~ dgamma(shape[i], rate[i])
    log(mu[i]) = beta2 + beta3*mass[i] - beta4*mass2[i]
    mu2[i] = pow(mu[i], 2)
    shape[i] = mu2[i]/sd2[i]
    rate[i] = mu[i]/sd2[i]
    sd2[i] ~ dgamma(0.001, 0.001)
  }
  
#priors
  beta1 ~ dnorm(0, 0.001)
  beta2 ~ dnorm(0, 0.001)
  beta3 ~ dnorm(0, 0.001)
  beta4 ~ dnorm(0, 0.001)
}
"

writeLines(Seeds_HM_JAGSmod, con='Seeds_HM_JAGSmod.txt')

```

```{r}

##put data into list to be used in Bayesian model

seedsDatList = list(SeedLost = seeds$seedLost, 
                    Gap = seeds$gap,
                    mass = seeds$mass,
                    mass2 = seeds$mass2,
                    N = nrow(seeds))

##set chains, burn in, and iterations
nchains = 2
nburnin = 1000
niter = 25000

##run JAGS model

Seeds_HM_JAGS = jags.model('Seeds_HM_JAGSmod.txt',
                           data = seedsDatList,
                           n.chains = nchains,
                           n.adapt = 1000)

update(Seeds_HM_JAGS, nburnin)
jags.samples(Seeds_HM_JAGS, c("beta1", "beta2", "beta3", "beta4"), niter, thin = 10)
              
```

Part ii: 
```{r}
##sample JAGS model using coda package to summarize model results  
Seeds_coda = coda.samples(Seeds_HM_JAGS, c("beta1", "beta2", "beta3", "beta4"), niter, thin = 10)

```

The parameter estimates and the 2.5%, 50%, and 97.5% percentiles are: 
```{r}
##summarize parameter estimates 
summary(Seeds_coda)
```

Part iii:
```{r}
##plot posterior distributions of each parameter 
plot(Seeds_coda, trace=FALSE)
```

Part iv: 
```{r}
##check traceplots for any visual signs of lack of convergence 
#par(mfrow = c(4,1))
#traceplot(Seeds_coda)


gelman.plot(Seeds_coda)
gelman.diag(Seeds_coda)
```

While the chains for the beta 1 parameter have converged, the beta 2, beta 3, and beta 4 parameters have not converged. The chains for these parameters are not mixing well, so it would take a large number of iterations for the values to converge. 
