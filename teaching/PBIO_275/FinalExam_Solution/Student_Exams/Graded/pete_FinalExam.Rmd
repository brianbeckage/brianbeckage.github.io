---
title: "pbio294 final"
author: "Peter Clark"
date: "December 8, 2017"
output: html_document
---

Below are the three questions for the PBIO 294 Final Exam.  All work must be your own.

Reference to outside sources should be limited to the documentation for R, Stan, JAGS, or general questions regarding pdf's, etc.  This exam is due by midnight, Monday, 11 Dec 2017. 20% will be deducted for each additonal 6 hours that this exam is turned in late. Please email your R/.Rmd file to brian.beckage@uvm.edu.


1. (30 points) An ecologist is interested in the intermediate disturbance hypothesis (IDH) that postulates that the highest species richness should be found at intermediate levels of disturbance. Write a  likelihood function to estimate the parameters for a quadratic regression models given in Beckage and Stout 2000 (http://www.uvm.edu/~bbeckage/Manuscripts/BeckageStout.corrected.2000.jvs.pdf), but assuming a Poisson likelihood with a log link function.  Provide your i. *likelihood function and supporting R code for finding the MLE's*, ii. a *plot of the data with the fitted line* and iii. report the *regression parameters (bo, b1, and b2)*, and iv. the value of the *negative log likelihood at the MLEs*.  Note:  You must write your own likelihood function and not use a built in R function or package, e.g, lm, glm, etc.

The data may be read using:
```{r}
srDat<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/idh.csv",sep=',',header=TRUE)
```


#Answer to Question 1

The quadratic equation from Beckage and Stout 2000:   

Y = b0 + b1 × Burns + b2 × Burns2 + E


```{r}
head(srDat)
###########################
#part 1: Writing my likelihood function 
###########################

nllPoi<-function(parVec,sr,nFires){
    burns<-nFires
    spR<-sr
    b0<-parVec[1]
    b1<-parVec[2]
    b2<-parVec[3]
  srPred<-exp(b0+b1*burns+b2*(burns^2)) # error term not needed because exp link
  nllik<- -sum(dpois(x=spR,lambda=srPred,log=TRUE))
  return(nllik)
}

#Using optim to get MLEs and nllik

parVec<-c(0.1,0.1,0.1) #  Additional parameter values tested (e.g., 1,1,1) with similar results, however method needs to be removed for optim to run 
outPois<-optim(par=parVec,fn=nllPoi,method="L-BFGS-B",lower=c(-Inf,-Inf),upper=c(Inf,Inf),sr=srDat$sr,nFires=srDat$nFires)

###########################
# part 3 regression params
###########################
outPois$par #regression params: b0: 2.05578969  b1: 0.44405624  b2: -0.04586403

###########################
# part 4 negative log likelihood
###########################
outPois$val # part 4 negative log likelihood: 848.0213

###########################
#part 2 plotting the data with a fitted line
###########################
plot(srDat$nFires,srDat$sr, xlab = "No. Fires", ylab = "Species Richness", main="Actual Richness x Fires plotted with Model Fit")
lines(srDat$nFires, exp(outPois$par[1]+outPois$par[2]*srDat$nFires+outPois$par[3]*(srDat$nFires)^2),col='blue',lwd=2)

```


2. (30 points) Repeat exercise 1 except now fitting the model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*, ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (bo, b1, and b2)*, iii. *plot the posterior distributions for each of these parameters* and iv. *assess the convergence of your chains using the Gelman-Rubin statistic.* 


### Fit the Poisson regression using Rjags


```{r}
sr<-srDat$sr
nFires<-srDat$nFires

library(rjags)

###########################
#PART 1
###########################

#### RUN MODEL STRING BELOW FIRST####

q2Jags <- jags.model('srPoisQuadReg.jags.txt',
                   data = list('spRichness' = sr,
                               'burns' = nFires,
                               'N' = length(nFires)),
                   inits<-list(
                       list('b0'=1,'b1'=1, 'b2'=1),
                       list('b0'=0.1,'b1'=0.1, 'b2'=0.1),
                       list('b0'=2,'b1'=2, 'b2'=2),
                       list('b0'=0.001,'b1'=0.001, 'b2'=0.001)),
                   n.chains = 4,
                   n.adapt = 100)
```

```{r}
update(q2Jags, 1000)

jags.samples(q2Jags,
             c('b0', 'b1', 'b2'),
             10000)
#jags.samples(model, variable.names, n.iter, thin = 1, type="trace", ...)
#parameter estimates for b0, b1, b2: 2.067598, 0.438318, and -0.04532878 respectively

```

```{r}
library(coda)
q2codaSamples<-coda.samples(q2Jags, c('b0', 'b1', 'b2'), 10000, 1)
summary(q2codaSamples)
###########################
#part 2: REGRESSION PARAMTERS AND QUANTILES
###########################

#Empirical mean and standard deviation for each variable, plus standard error of the mean:
#       Mean       SD  Naive SE Time-series SE
#b0  2.06172 0.057227 2.861e-04      0.0033148
#b1  0.44085 0.023230 1.162e-04      0.0015306
#b2 -0.04555 0.002125 1.063e-05      0.0001331

########Quantiles for each parameter:############
#       2.5%      25%      50%      75%    97.5%
#b0  1.94455  2.01782  2.05664  2.09637  2.16374
#b1  0.39937  0.42670  0.44290  0.45931  0.48965
#b2 -0.05005 -0.04723 -0.04574 -0.04426 -0.04172


###########################
#part 3: Density plots of posterior distribtions for b0, b1, and b2
###########################
plot(q2codaSamples, trace = TRUE, density = TRUE)

###########################
#part 4: assessing convergence using Traceplots (see plots) and Gelmin Rubin Statistic
###########################

##Gelman and Rubin's convergence diagnostic
#The 'potential scale reduction factor' is calculated for each variable in x, together with upper and lower confidence limits. Approximate convergence is diagnosed when the upper limit is close to 1

gelman.diag(q2codaSamples, confidence = 0.95, transform=FALSE, autoburnin=TRUE, multivariate=TRUE)
#Potential scale reduction factors:
#   Point est. Upper C.I.
#b0       1.01       1.03
#b1       1.01       1.04
#b2       1.01       1.03
#Multivariate psrf
#1.01

## Approximate convergence appears to be good because all of the reducation factors of the point estimates and upper limits are darn close to 1

# for fun, lets view to Gelman-Rubin-Brooks plot, which shows the evolution of Gelman and Rubin's shrink factor as the number of iterations increases.
gelman.plot(q2codaSamples, bin.width = 10, max.bins = 50, confidence = 0.95, transform = FALSE, autoburnin=TRUE, auto.layout = TRUE)
```

```{r}
modelSRPoisString<-"
model {
  for (i in 1:N){
    spRichness[i] ~ dpois(lam.hat[i])
    log(lam.hat[i]) <- b0+b1*burns[i]+b2*(burns[i]*burns[i]) #quadratic equation from Beckage and Stout 2000
  }
  b0 ~ dnorm(0, .0001)
  b1 ~ dnorm(0, .0001)
  b2 ~ dnorm(0, .0001)
}
"
writeLines(modelSRPoisString, con='srPoisQuadReg.jags.txt')
```


3. (40 points) An ecologist expects seed predation to be influenced by the presence of openings (gaps) in the forest overstory and seed mass. The effect of seed mass on predation is expected be quadratic:  Small seeds will be less predated because they offer a lower energetic reward while larger seeds will be too difficult to process, so that medium sized seeds will be most predated.  The effect of a gap is additive with lower predation expected in gaps because seed predators avoid areas of open canopy. The ecologist models the data as a hierarchical logistic regression, assuming that the seed masses are known without observation error.  The model has the form:

Seed lost ~ Binomial(theta) # 1 if seed is predated, 0 if seed is left alone
Logit(theta) = b0i + b1 x gap 
b0i ~ gamma(mu^2/sd^2,mu/sd^2) 
mui = b2 + b3 x seed mass i - b4 x (seed mass i)^2 
sd^2 ~ gamma(0.001,0.001)
b1,b2,b3,b4 ~ normal(0,100)

Fit this model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*, ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (b1, b1, b2, b3, and b4)*, iii. *plot the posterior distributions for each of these parameters* and iv. *assess the convergence of your chains using the Gelman-Rubin statistic.*

The data can be read using:
```{r}
seeds<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/seeds.csv",sep=',',header=TRUE)
str(seeds)
head(seeds) #seedLost    mass      gap
#           integer0-1   number   int 0-1
sLost<-seeds$seedLost
mass<-seeds$mass
isGap<-seeds$gap
N<-length(isGap)

```

```{r}
modelQ3String<-"
model {
  for (i in 1:N) {
    seedLost[i] ~ dbern(theta[i]) #needs to be bernoulli because its 1
    logit(theta[i]) <- b0[i] + b1 * gap[i]
    b0[i] ~ dgamma((mu[i]*mu[i])/(sd*sd),mu[i]/(sd*sd))
    log(mu[i]) <- b2 + b3 * seedMass[i] - b4 * (seedMass[i]*seedMass[i]) #mu has to be positive
  }
#priors
    sd ~ dgamma(0.001,0.001)
    b1 ~ dnorm(0,100)
    b2 ~ dnorm(0,100)
    b3 ~ dnorm(0,100)
    b4 ~ dnorm(0,100)
}
"
writeLines(modelQ3String, con='SeedLostReg.jags.txt')
```


```{r}
q3Jags <- jags.model('SeedLostReg.jags.txt',
                     data = list('seedLost' = sLost,
                                 'seedMass' = mass,
                                 'gap' = isGap,
                                 'N' = N),
                     #inits<-list(
                     #     list('b0'=1,'b1'=1,'b2'=1,'b3'=1,'b4'=1),
                     #     list('b0'=0.1,'b1'=0.1,'b2'=0.1,'b3'=0.1,'b4'=0.1),
                     #     list('b0'=2,'b1'=2,'b2'=2,'b3'=2,'b4'=2),
                     #     list('b0'=0.5,'b1'=0.5,'b2'=0.5,'b3'=0.5,'b4'=0.5)),
                     n.chains = 4,
                     n.adapt = 100)
```


```{r}
update(q3Jags, 1000)

jags.samples(q3Jags,
             c('b1', 'b2', 'b3', 'b4'),
             1001) #changed number of iterations to 1001 b/c computer struggled with more

```

```{r}
library(coda)
q3codaSamples<-coda.samples(q3Jags, c('b1', 'b2', 'b3', 'b4'), 1000, 1)
summary(q3codaSamples)
###########################
#part 2
###########################
#summary(q3codaSamples)

#Empirical mean and standard deviation for each variable, plus standard error of the mean:

#        Mean       SD  Naive SE Time-series SE
#b1  0.522037 0.086696 1.371e-03      0.0027001
#b2 -0.072228 0.107474 1.699e-03      0.0143435
#b3  0.006605 0.051527 8.147e-04      0.0116663
#b4 -0.011488 0.005571 8.809e-05      0.0009352

#Quantiles for each variable:

#       2.5%      25%      50%        75%     97.5%
#b1  0.34930  0.46506  0.52227  0.5796572  0.695378
#b2 -0.26900 -0.14742 -0.07342 -0.0002652  0.143063
#b3 -0.09879 -0.03016  0.02029  0.0464097  0.089185
#b4 -0.02242 -0.01656 -0.01003 -0.0069430 -0.003563

###########################
#part 3: 
###########################
plot(q3codaSamples, trace = F, density = TRUE)

###########################
#part 4: 
###########################

##Gelman and Rubin's convergence diagnostic

gelman.diag(q3codaSamples, confidence = 0.95, transform=FALSE, autoburnin=TRUE, multivariate=TRUE)
#Potential scale reduction factors:

#   Point est. Upper C.I.
#b1       1.11       1.30
#b2       1.53       2.26
#b3       2.20       3.98
#b4       2.37       4.34

#Multivariate psrf
#2.18


## Approximate convergence is ok for b1 but b2-4 do no converge (because all of the reducation factors of upper limits are nowhere close to 1). This could be improved with many many more iterations

# for fun, lets view to Gelman-Rubin-Brooks plot, which shows the evolution of Gelman and Rubin's shrink factor as the number of iterations increases.
gelman.plot(q3codaSamples, bin.width = 10, max.bins = 50, confidence = 0.95, transform = FALSE, autoburnin=TRUE, auto.layout = TRUE)
```
