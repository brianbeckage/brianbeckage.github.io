---
title: "Final Exam PIBO"
author: "Maike Holthuijzen"
date: "December 11, 2017"
output: pdf_document
---
1. Intermediate disturbance hypothesis analysis.

The MLE estimates for $\beta_0, \beta_1$, and $\beta_2$ were 2.056, 0.44, and -0.045, respectively. The negative log likelihood was  848.023.
```{r }

library(rjags)
library(coda)
srDat<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/idh.csv",sep=',',header=TRUE)

nfires = srDat$nFires
sr = srDat$sr
firesq = srDat$nFires^2

firePoiQuad = function(parVec,nfires,sr,firesq){
  b0 = parVec[1]
  b1 = parVec[2]
  b2 = parVec[3]
  firepreds <- exp(b0 + b1*nfires + b2*firesq)
  nllik = -sum(dpois(x = sr, lambda = firepreds,log=TRUE))
  # cat("nllik= ",nllik,sep=" ",fill=T);cat(" ",sep=" ",fill=T)
  return(nllik)
}

parVec = c(1, 1.0, -.5) # Initial parameter values 
MLestimates = optim(par = parVec,fn=firePoiQuad, method="L-BFGS-B", lower=c(-10, -10, -2),
               upper=c(5, 5, 0), nfires = nfires, sr = sr, firesq = firesq)
#parameter estimates for b0, b1, and b2
MLestimates$par

#negative log likelihood value
MLestimates$value

#plot
burnpreds  = nfires[order(nfires)]
Species_richness = srDat$sr
plot(burnpreds, Species_richness, pch = 19, col = "blue", ylim = c(5, 45), xlab = "Number of burns", ylab = "Species richness")
lines(burnpreds, exp(MLestimates$par[1] + MLestimates$par[2]*burnpreds + MLestimates$par[3]*firesq) , col = 'red', lwd = 2)
legend("topright", legend=c("Actual vales", "Fitted values"),
       col=c("blue", "red"), pch=c(19, NA), lty=c(NA, 1), cex=1, lwd=2)
```



2. (30 points) Repeat exercise 1 except now fitting the model using either Rstan or Rjags.  The jags model, along with resulting plots of the posterior distributions for parameters and predicted values is shown below. 

```{r }
library(rjags)
library(coda)
#scaling function for plotting (below)
scale2 <- function(x) {
  sdx <- sqrt(var(x))
  meanx <- mean(x)
  return((x - meanx)/sdx)
}

jags.data = list(nobs = length(nfires), sr = sr, nfires = nfires)

#jags model
modelstring = "
model
{
  # uninformative priors
  beta0 ~ dnorm(0,0.001)
  beta1 ~ dnorm(0,0.001)
  beta2 ~ dnorm(0,0.001)
  
  # likelihood
  for(i in 1:nobs)
  {
    sr[i] ~ dpois(lambda[i])
    log(lambda[i]) <- beta0 + beta1*nfires[i] + beta2*pow(nfires[i],2)
    # get predicted values
    prediction[i] ~ dpois(lambda[i])
  } 
}
"
writeLines(modelstring, con='poisFire.txt')
params = c("beta0", "beta1", "beta2", "prediction")

jm = jags.model("poisFire.txt", data = jags.data, n.chains = 3, n.adapt = 1000)
update(jm, n.iter = 1000)
jm.sample = jags.samples(jm, variable.names = params, n.iter = 10000, thin = 1)

#plot posterior densities of parameters
plot(as.mcmc.list(jm.sample$beta0), main = "Beta_0")
plot(as.mcmc.list(jm.sample$beta1), main = "Beta_1")
plot(as.mcmc.list(jm.sample$beta2), main = "Beta_2")

#summary of posterior di for parameters
summary(as.mcmc.list(jm.sample$beta0))
summary(as.mcmc.list(jm.sample$beta1))
summary(as.mcmc.list(jm.sample$beta2))

#obtain predicted values for plot
predictions = summary(as.mcmc.list(jm.sample$prediction))
mypreds = data.frame(scfires = scale2(nfires), predictions$quantiles)
mypreds = mypreds[order(mypreds[, 1]), ]

#make plot
plot(scale2(nfires), sr, cex = 1, col = "lightgrey", pch = 19, ylab = " species richness", 
     xlab = "Scaled number of fires")
lines(mypreds[, 1], mypreds[, 2], lwd = 2)
lines(mypreds[, 1], mypreds[, 4], lwd = 2, col = "red")
lines(mypreds[, 1], mypreds[, 6], lwd = 2)

legend("topleft", legend = c("95% P.I.", "predicted values"), col = c("black", "red"), 
       lwd = c(2, 2))

```


The HPD intervals and Gelman statistic are listed below. The Gelman - Rubin statistics for each of the three parameters are near 1, satisfying the criteria for adequate convergence of the MCMC chains.
```{r }
#make this an "mcmc.list".
beta0Obj <- as.mcmc.list(jm.sample$beta0)
beta1Obj = as.mcmc.list(jm.sample$beta1)
beta2Obj = as.mcmc.list(jm.sample$beta2)

#gelman rubin statistic
gelman.diag(beta0Obj)
gelman.diag(beta1Obj)
gelman.diag(beta2Obj)


#high density interval
HPDinterval(beta0Obj)
HPDinterval(beta1Obj)
HPDinterval(beta2Obj)
```


3. Seed predation. The final model has the form:
  
 Seed lost ~ Binomial(theta) # 1 if seed is predated, 0 if seed is left alone 
 Logit(theta) = b0i + b1 x gap  
 b0i ~ gamma(mu^2/sd^2,mu/sd^2)  
 mui = b2 + b3 x seed mass i - b4 x (seed mass i)^2  
 sd^2 ~ gamma(0.001,0.001) 
 b1,b2,b3,b4 ~ normal(0,100) 


  The data can be read using:
```{r }
library(rjags)
library(coda)
seeds<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/seeds.csv",sep=',',header=TRUE)


N = length(seeds$seedLost)
seedsLost = seeds$seedLost
gap = seeds$gap
mass = seeds$mass

data_jags = list(N = N, seedsLost = seedsLost, gap = gap, mass = mass)

```

The jags model is:

```{r }
modelstring3 = "
model {
# N observations
for (i in 1:N) {
seedsLost[i] ~ dbern(theta[i])
logit(theta[i]) <-  beta0[i] + beta1*gap[i]
mu[i] <- beta2 + beta3*mass[i] + beta4*pow(mass[i], 2)
beta0[i] ~ dgamma( pow(m1[i], 2) / b , m1[i] / b )
m1[i] = mu[i] +0.01
}

b  ~ dgamma(.001, .001)

beta1     ~ dnorm(0.0, 100)
beta2   ~ dnorm(0.0, 100)
beta3 ~ dnorm(0.0, 100)
beta4  ~ dnorm(0.0, 100)
}
"


writeLines(modelstring3, con='seeds3.txt')
params = c("beta1", "beta2", "beta3", "beta4")
mod = jags.model('seeds3.txt', data=data_jags, n.chains=3)

update(mod, 10000)
mod_sim <- jags.samples(mod, variable.names = params, n.iter = 10000, thin = 10)

```


Posterior density plots and summaries of posterior densities:
```{r }
plot(as.mcmc.list(mod_sim$beta1))
plot(as.mcmc.list(mod_sim$beta2))
plot(as.mcmc.list(mod_sim$beta3))
plot(as.mcmc.list(mod_sim$beta4))

summary(as.mcmc.list(mod_sim$beta1))
summary(as.mcmc.list(mod_sim$beta2))
summary(as.mcmc.list(mod_sim$beta3))
summary(as.mcmc.list(mod_sim$beta4))
```

The Gelman-Rubin statistics for all of the four parameters suggest convergence issues, especially for $\beta_3$. Values around 1 of the Gelman-Rubin statistic are desirable. Poor convergence among the four chains is also apparent in the trace plots. Increasing the number of iterations from 5000 to 10000 did help somewhat with convergence, but the computation time increased considerably.
```{r }

#convert to "mcmc.list".
B1 = as.mcmc.list(mod_sim$beta1)
B2 = as.mcmc.list(mod_sim$beta2)
B3 = as.mcmc.list(mod_sim$beta3)
B4 = as.mcmc.list(mod_sim$beta4)

#gelman rubin statistic
gelman.diag(B1)
gelman.diag(B2)
gelman.diag(B3)
gelman.diag(B4)


#high density interval
HPDinterval(B1)
HPDinterval(B2)
HPDinterval(B3)
HPDinterval(B4)
```

