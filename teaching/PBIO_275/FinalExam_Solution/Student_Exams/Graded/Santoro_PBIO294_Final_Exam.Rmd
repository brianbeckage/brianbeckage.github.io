---
title: "R Notebook"
output: Final Exam
---
Jen Santoro  

**IMPORTANT NOTE ON SETWD**  
```{r}
setwd("D:/Jen Santoro/Documents/Vermont/Fall2017/Bayes/FinalExam")  
# NOTE: this is for saving the JAGS model string. Please change to local path for models to work!

```



Below are the three questions for the PBIO 294 Final Exam.  All work must be your own.  Reference to outside sources should be limited to the documentation for R, Stan, JAGS, or general questions regarding pdf's, etc.  This exam is due by midnight, Monday, 11 Dec 2017. 20% will be deducted for each additonal 6 hours that this exam is turned in late. Please email your R/.Rmd file to brian.beckage@uvm.edu.  


1. (30 points) An ecologist is interested in the intermediate disturbance hypothesis (IDH) 
that postulates that the highest species richness should be found at intermediate levels of 
disturbance. Write a  likelihood function to estimate the parameters for a quadratic regression models given in Beckage and Stout 2000 
(http://www.uvm.edu/~bbeckage/Manuscripts/BeckageStout.corrected.2000.jvs.pdf), 
but assuming a Poisson likelihood with a log link function.  Provide your:   
i. *likelihood function and supporting R code for finding the MLE's*,  
ii. a *plot of the data with the fitted line* and  
iii. report the *regression parameters (bo, b1, and b2)*, and  
iv. the value of the *negative log likelihood at the MLEs*.  
Note:  You must write your own likelihood function and not use a built in R function or package, e.g, lm, glm, etc.  

The data may be read using:  
```{r}
srDat<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/idh.csv",sep=',',header=TRUE)
head(srDat)
nFires2 <- (srDat$nFires)^2   # for ease of coding later
srDat$nFires2 <- nFires2
# sr = species richness
# nFires = number of fires
# quadratic model, from paper: Yhat = b0 + b1*Burns + b2*Burns^2 + error
# in dataframe terms: sr = b0 + b1*nFires + b2*(nFires^2) + error
# POISSON LIKELIHOOD, LOG LINK
```
  
Part i: Likelihood function and MLEs  
```{r}
# Set up likelihood function (poisson likelihood with log link)
nllPois <- function(params, spprich, nBurn){
    b0 <- params[1]
    b1 <- params[2]
    b2 <- params[3]
  spprichPred <- exp(b0 + b1 * nBurn + b2 * (nBurn)^2)  # log link in exp
  nllik <- -sum(dpois(x = spprich, lambda = spprichPred, log = TRUE))
  return(nllik)
}


# Feed in species richness data to nllPois function
params <- c(2.0, 0.5, -0.1)     # initial guesses at paramater values
# These guesses were informed by running a classic GLM in R. With optim, things were getting stuck, so I used GLM to inform parameter estimates for my hand-coded NLL model.
# Another method: start with 0s and see where optim takes you.

outSRPois <- optim(par = params, fn = nllPois, spprich = srDat$sr, nBurn = srDat$nFires)
outSRPois$par # b0 MLE = 2.07   b1 MLE = 0.44   b2 MLE = -0.05
outSRPois$val # nllik = 847.99

```
  
TEST: Compare to built-in LM/GLM to see if my likelihood function is correct:  
```{r}
testmod2 <- glm(sr ~ nFires + nFires2, data = srDat, family = poisson(link = log))
summary(testmod2)   # b0 = 2.07   b1 = 0.44   b2 = -0.05
# parameters check out with my likelihood function.

```
  
Part ii: Plot data with fitted line  
```{r}
plot(srDat$nFires, srDat$sr, main = "Species Richness by Fire Frequency",
     xlab = "Number of Fires", ylab = "Species Richness")
yforplot <- exp(outSRPois$par[1] + outSRPois$par[2] * srDat$nFires + outSRPois$par[3] * srDat$nFires2)
lines(srDat$nFires, yforplot, col = 'red', lwd = 2)

```
  
Part iii: Regression Parameters  
```{r}
# From outSRPois parameters above:
# b0 MLE = 2.07   
# b1 MLE = 0.44   
# b2 MLE = -0.05
```
  
Part iv: Report value of NLL at MLEs  
```{r}
# From outSRPois parameters above:
# negative log likelihood estimate = 847.99

```

  
2. (30 points) Repeat exercise 1 except now fitting the model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your:   
i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*,  
ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (bo, b1, and b2)*,  
iii. *plot the posterior distributions for each of these parameters* and  
iv. *assess the convergence of your chains using the Gelman-Rubin statistic.*   
  
Part i: STAN/JAGS model code  
```{r}
# JAGS model set-up
library(rjags)

sppRichness <- srDat$sr
nFires <- srDat$nFires
nFires2 <- srDat$nFires2

SRmodelString<-"
model {
  for (i in 1:N){
    sppRichness[i] ~ dpois(lam.hat[i])
    log(lam.hat[i]) <- b0 + b1 * nFires[i] + b2 * nFires2[i]
  }
  b0 ~ dnorm(0, .0001)
  b1 ~ dnorm(0, .0001)
  b2 ~ dnorm(0, .0001)
}
"
writeLines(SRmodelString, con = 'SRPois.jags.txt')


# Run JAGS model from SRmodelString text file
SRjags <- jags.model('SRPois.jags.txt',
                   data = list('sppRichness' = sppRichness,
                               'nFires' = nFires,
                               'nFires2' = nFires2,
                               'N' = length(nFires)),
                   inits <- list(
                       list('b0' = 1,'b1' = 2, 'b2' = 1),
                       list('b0' = 1,'b1' = 0.2, 'b2' = 0.2),
                       list('b0' = 0.1,'b1' = 2, 'b2' = 1),
                       list('b0' = 2,'b1' = 5, 'b2' = 0.2)),
                   n.chains = 4,
                   n.adapt = 100)

update(SRjags, 1000)

jags.samples(SRjags, c('b0', 'b1', 'b2'), 10000)
# b0 = 2.07   b1 = 0.44   b2 = -0.05

library(coda)
SRcodaSamp<-coda.samples(SRjags, c('b0','b1', 'b2'), 10000, 1)

```
  
CHECK VIA BRMS  
```{r}
library(brms)

testmodBRM <- brm(formula = sr ~ nFires + nFires2,
            data = srDat, family = poisson(link = log),
            warmup = 1000, iter = 2000, chains = 4)

summary(testmodBRM)
# b0 = 2.06   b1 = 0.44   b2 = -0.05
# parameters check out with my JAGS model.
plot(testmodBRM)

plot(marginal_effects(testmodBRM), points = TRUE)

```

  
Part ii: Report percentiles for regression parameters  
```{r}
summary(SRcodaSamp)
# b0 = 2.06   b1 = 0.44   b2 = -0.05
# Quantiles
#        2.5%      25%      50%      75%   97.5%
# b0  1.94547  2.02472  2.06353  2.10087  2.1733
# b1  0.39367  0.42470  0.44017  0.45565  0.4883
# b2 -0.04989 -0.04692 -0.04548 -0.04406 -0.0412

```
  
Part iii: Plot posterior distributions for each parameter  
```{r}
plot(SRcodaSamp, trace = TRUE, density = TRUE)

```
  
Part iv: Assess chain convergence with Gelman-Rubin statistic  
```{r}
# The gelman.diag gives you the scale reduction factors for eachparameter. A factor of 1 means that between chain variance and within chain variance are equal, larger values mean that there is still a notable difference between chains. A rule of thumb is that values of 1.1 and less suggests adequate convergence.

gelman.diag(SRcodaSamp)   # values are < 1.1 so this suggests adequate chain convergence
# Potential scale reduction factors:
#    Point est. Upper C.I.
# b0       1.02       1.06
# b1       1.03       1.08
# b2       1.02       1.07
# 
# Multivariate psrf
# 1.03

gelman.plot(SRcodaSamp)

```


  
3. (40 points) An ecologist expects seed predation to be influenced by the presence of openings (gaps) in the forest overstory and seed mass. The effect of seed mass on predation is expected be quadratic:  Small seeds will be less predated because they offer a lower energetic reward while larger seeds will be too difficult to process, so that medium sized seeds will be most predated.  The effect of a gap is additive with lower predation expected in gaps because seed predators avoid areas of open canopy. The ecologist models the data as a hierarchical logistic regression, assuming that the seed masses are known without observation error.  The model has the form:  
  
Seed lost ~ Binomial(theta) # 1 if seed is predated, 0 if seed is left alone  
Logit(theta) = b0i + b1 x gap  
b0i ~ gamma(mu^2/sd^2,mu/sd^2)   
mui = b2 + b3 x seed mass i - b4 x (seed mass i)^2   
sd^2 ~ gamma(0.001,0.001)  
b1,b2,b3,b4 ~ normal(0,100)  
  
Fit this model using either Rstan or Rjags.  You must write your own Stan/JAGS model, meaning that you can not use one of the Stan helper libraries such as the brms or rstanarm libraries. Provide your:  
i. *Stan/JAGS model code and supporting R code for running the Stan/JAGS model*,  
ii. report the *2.5%, 50%, and 97.5% percentiles for the regression parameters (b1, b1, b2, b3, and b4)*,  
iii. *plot the posterior distributions for each of these parameters* and  
iv. *assess the convergence of your chains using the Gelman-Rubin statistic.*  
  
The data can be read using:  
```{r}
seeds<-read.table("http://www.uvm.edu/~bbeckage/Teaching/PBIO_294/Data/seeds.csv",sep=',',header=TRUE)
head(seeds)

```
  
Part i: STAN/JAGS model code  
```{r}
# set up JAGS model with vector variables
seedLost <- as.numeric(seeds$seedLost)
smass <- as.numeric(seeds$mass)
gap <- as.numeric(seeds$gap)
Nseed <- length(seedLost)
Ngap <- length(levels(as.factor(seeds$gap)))


# Set up JAGS model string
PredationModelString<-"
model {
  for (i in 1:Nseed) {
    seedLost[i] ~ dbern(theta[i])
    logit(theta[i]) <- b0[i] + b1 * gap[i]
    b0[i] ~ dgamma(mu[i]^2/sd^2, mu[i]/sd^2)
    log(mu[i]) <- b2 + b3 * smass[i] - b4 * smass[i]^2   # gamma params must be positive; add log
  }
# Priors
  sd ~ dgamma(0.001, 0.001)
  b1 ~ dnorm(0, 100)
  b2 ~ dnorm(0, 100)
  b3 ~ dnorm(0, 100)
  b4 ~ dnorm(0, 100)
}
"
writeLines(PredationModelString, con = 'PredBinom.jags.txt')

# Run JAGS from PredationModelString text file. INITS were eliminated, but chains kept at 4.
Predjags <- jags.model('PredBinom.jags.txt',
                   data = list('seedLost' = seedLost,
                               'smass' = smass,
                               'gap' = gap,
                               'Nseed' = Nseed),
                   n.chains = 4,
                   n.adapt = 100)

update(Predjags, 1000)

jags.samples(Predjags, c('b1', 'b2', 'b3', 'b4'), 10000)
# b1 = 0.5295   b2 = -0.1232   b3 = -0.0304   b4 = -0.0146 

PredcodaSamp<-coda.samples(Predjags, c('b1', 'b2', 'b3', 'b4'), 10000, 1)


```

  
Part ii: Report percentiles for regression parameters  
```{r}
summary(PredcodaSamp)
# Quantiles
#        2.5%      25%      50%      75%     97.5%
# b1  0.36547  0.47143  0.52768  0.58350  0.687949
# b2 -0.25167 -0.17371 -0.12485 -0.06154  0.049748
# b3 -0.10064 -0.08304 -0.05020 -0.02492  0.043840
# b4 -0.02047 -0.01858 -0.01638 -0.01314 -0.009032

```
  
Part iii: Plot posterior distributions for each parameter  
```{r}
plot(PredcodaSamp, trace = TRUE, density = TRUE)
# not great convergence on b2, b3, or b4

```
  
Part iv: Assess chain convergence with Gelman-Rubin statistic  
```{r}
gelman.diag(PredcodaSamp) 
# Potential scale reduction factors:
#    Point est. Upper C.I.
# b1       1.02       1.05
# b2       1.47       2.19
# b3       2.50       5.39
# b4       2.25       4.55
# Multivariate psrf
# 2.79

# values are < 1.1  for b1 so this suggests adequate chain convergence
# values are > 1.1  for b2, b3, and b4, so this suggests NO adequate chain convergence

gelman.plot(PredcodaSamp)

```

